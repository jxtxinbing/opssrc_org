# OpenSwitch Modular Configuration Design


## Contents

- [High level design of OpenSwitch Modular Configuration](#high-level-design-of-openswitch-modular-configuration)
- [Participating modules](#participating-modules)
   - [Kconfig system](#kconfig-system)
   - [Kconfig files layout](#kconfig-files-layout)
   - [Custom scripts](#custom-scripts)
   - [OVSDB-Schema](#ovsdb-schema)
   - [CIT framework](#cit-framework)
- [Design choices](#design-choices)
   - [Mapping file](#mapping-file)
   - [Repo level Kconfig files](#repo-level-kconfig-files)
   - [menuconfig for platform selection](#menuconfig-for-platform-selection)
- [References](#references)

## High level design of OpenSwitch Modular Configuration

OpenSwitch Modular Configuration allows users to carry out build time
customization of the OpenSwitch image. Features can be enabled/disabled, and
parameters can be changed through the framework resulting in a customized
OpenSwitch image.

At a high level, the design of Modular Configuration framework is classified
into four categories:

* Kconfig system which handles the configuration front-end, providing a UI for
  user interaction.
* A set of scripts running under the Yocto build infrastructure, that convert
  configuration options generated by the Kconfig system into compatible Yocto
  code.
* Enhancements to the OpenSwitch schema that help scripts identify and prune
  schema entries related to disabled features.
* Enhancements to the CIT framework that help identify and exclude tests
  related to disabled features.

Details about the above four categories are covered in following sections.
```ditaa

    +--------------------+     +-------------+
    |    .ops-config     |     |             |
    | (default/generated +--+-->   Kconfig   |    +------------------+
    | from previous run) |  |  |   System    <----> User Interaction |
    +--------------------+  |  |             |    +------------------+
                            |  +------+------+
      +---------------+     |         |
      | Kconfig files +-----+         |
      +---------------+        +------v------+
                               | .ops-config |
                               |  (modified) |
                               +------+------+
                                      |
                                      |
                          +------------------------+
                          |           |            |
                          |     +-----v-----+      |    +------------+
                          |     |  Custom   |      |    | OpenSwitch |
                          |     |  python   <-----------+   Schema   |
                          |     |  scripts  |      |    +------------+
     +---------------+    |     +-----------+      |
     |    Enabled    |    |                        |
     | features and  <----+ OpenSwitch Yocto Build |
     | Manifest File |    |         System         |
     +-------+-------+    |                        |
             |            +-----------+------------+
             |                        |
             |                        |
      +------v------+     +-----------v------------+
      | OpenSwitch  |     |                        |
      | CIT System  +----->    OpenSwitch Image    |
      +-------------+     |                        |
                          +------------------------+

```

## Participating modules

### Kconfig system

The Kconfig front-end system is pulled into the OpenSwitch Yocto build
environment, built and executed as part of a new make target `make menuconfig`.
The recipe kconfig-frontends.bb is involved in this process. Since the
front-end is run on the native/host system, a native version of the recipe is
used.

The Kconfig system parses the provided Kconfig files, works out all feature
dependencies, and presents the UI to the user. It generates a configuration
file consisting of enabled Kconfig symbols and parameter values (.ops-config)
when the user exits the UI. Every time the UI is launched, a saved set of user
selected information is picked up from the existing .ops-config file.

The .ops-config file is platform specific. This helps in preserving user
choices across platform selections. Symbolic links are used to facilitate this
process.

### Kconfig files layout

The Kconfig files dictate the UI and dependencies between Kconfig symbols.
These files follow standard Kconfig language syntax. The following diagram
shows how Kconfig files are organized in the OpenSwitch repository.

```ditaa
    +----------------------------------------------------------------------+
    |                        Root Kconfig file                             |
    |                                                                      |
    | * Located at $(BUILD_ROOT)/tools/config/                             |
    | * Fed to Kconfig System                                              |
    | * Imports build environment variables into Kconfig system            |
    +---------------------------------+------------------------------------+
                                      |
                                      |
    +---------------------------------v------------------------------------+
    |                  Platform specific Kconfig file                      |
    |                                                                      |
    | * Located at: $(BUILD_ROOT)/yocto/$(DISTRO)/meta-platform-$(DISTRO)- |
    |   $(CONFIGURED_PLATFORM)/                                            |
    | * Defines features and values specific to the platform               |
    | * "Select" features applicable only to a subset of platforms. These  |
    |   shared features are defined elsewhere                              |
    +-------------------------+-----------------------------------+--------+
                              |                                   |
                              |                                   |
    +-------------------------v----------------------------+      |
    |         Vendor specific Kconfig files                |      |
    |                                                      |      |
    | * Located at $(BUILD_ROOT)/tools/config/             |      |
    | * Defines features specific to a platform/forwarding |      |
    |   ASIC vendor                                        |      |
    +------------------------------------------------------+      |
                                                                  |
                                                                  |
    +-------------------------------------------------------------v--------+
    |                        Common Kconfig files                          |
    |                                                                      |
    | * These files define features that are visible across all platforms  |
    | * New files can be added on a need basis                             |
    | * $(BUILD_ROOT)/yocto/openswitch/meta-distro-openswitch/recipes-ops/ |
    |   l2 defines L2 features                                             |
    | * $(BUILD_ROOT)/yocto/openswitch/meta-distro-openswitch/recipes-ops/ |
    |   l3 defines L3 and above features                                   |
    | * $(BUILD_ROOT)/yocto/openswitch/meta-distro-openswitch/recipes-ops/ |
    |   mgmt defines switch management related options                     |
    | * $(BUILD_ROOT)/yocto/openswitch/meta-distro-openswitch/recipes-ops/ |
    |   utils defines tools, utilities and troubleshooting options         |
    +----------------------------------------------------------------------+
```

### Custom scripts

In OpenSwitch, each repository is represented by a bitbake recipe and creates a
package. A feature can either directly map to a repository or a repository can
host multiple sub-features. The cases where a feature has a one-to-one mapping
with a repository, feature enable/disable is controlled by including/excluding
the corresponding package, IMAGE_FEATURES, and FEATURE_PACKAGES options of
Yocto are used for this purpose. Yocto further works out the package dependency
tree and includes/excludes all dependent packages both external and OpenSwitch
specific. In cases where a repository hosts multiple sub-features, or if a
key-value parameter has to be passed on, build flags are passed to the
repository level make environment through recipe files.

The above tasks are handled by custom scripts that run inside the OpenSwitch
Yocto build as part of the `make` target.

### OVSDB-Schema

The OVSDB-schema is captured as part of the JSON format file (for example,
vswitch.extschema), and the corresponding XML format file (for example,
vswitch.xml).

When certain features are disabled as part of the OpenSwitch Modular
Configuration, the corresponding fields in the schema used by those features
need to be pruned. The fields used by the features are tagged with the Kconfig
symbol. For example, fields that need to be pruned could be Table/Column/Enum
(JSON Format) or Table/Group/Column (XML Format).

The ops recipe has been modified to trigger the schema pruning scripts that
prune the JSON and XML formats of the corresponding fields in the schema during
`make`.

Refer to the user-guide for the steps to follow when tagging the schema.

### CIT framework

The CIT framework deploys “pytest” to run the component/feature test-scripts.

As part of the OpenSwitch Modular Configuration, when a certain feature is
disabled, the tests corresponding to it should not be run (as they will fail).
A file containing the list of enabled features is generated as part of `make`,
and is also available as a manifest file with the released/periodic builds.
These files act as inputs to the test framework, providing a mechanism for
every test-script to know which features have been enabled. The test script
needs to use pytest markers to skip certain tests.

Refer to the user-guide for the exact steps to follow while skipping the tests.

## Design choices

Following alternates were considered during the design.

### Mapping file

A centralized file that carries the Kconfig symbol to the Yocto package
mapping, so the Kconfig symbol to schema entry mapping and Kconfig symbol to
test scripts mapping can be kept.

Following are some disadvantages with this scheme:

* Additional manual step, prone to errors
* Mapping file can grow large and difficult to maintain
* For the schema, the mapping file closely resembles the schema file,
  duplicating work

### Repo level Kconfig files

Instead of keeping all Kconfig files in ops-build, it is recommended to spread
them across repos, essentially keeping one Kconfig file per repo/feature.

Following are some disadvantages with this scheme:

* Increased build system complexity and reduced speed
* Loss of UI flexibility
* Loss of readability - of both the Kconfig file tree and the feature tree
* Harder to handle certain cases like common feature sets and multiple
  implementations of the same feature

### menuconfig for platform selection

Instead of `make configure` or `make switch-platform`, use `make menuconfig`
to select a platform.

Following are some disadvantages with this scheme:

* Each platform has its own configuration file. So to load a configuration
  file, the platform should be known
* Interactive process, not script friendly
* menuconfig is supposed to be an optional step and for most of the time, the
  default configuration file should take care of feature sets

## References

* [Kconfig Language Syntax](https://www.kernel.org/doc/Documentation/kbuild/kconfig-language.txt)
* [OpenSwitch Modular Configuration User Guide](http://git.openswitch.net/cgit/openswitch/ops/tree/docs/OpenSwitch_Modular_Configuration_user_guide.md)
* [IRC Discussion](http://eavesdrop.openswitch.net/irclogs/%23openswitch/%23openswitch.2015-11-11.log.html)
